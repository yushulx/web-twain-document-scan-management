<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>Document Management App - Dynamsoft</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script type="text/javascript" src="https://unpkg.com/dwt/dist/dynamsoft.webtwain.min.js"></script>
	<link href="css/index.css" rel="stylesheet" />
</head>

<body>
	<!-- License Activation Overlay -->
	<div id="licenseOverlay" class="license-overlay">
		<div class="license-card">
			<div class="license-header">
				<h1>üöÄ Activate Your License</h1>
				<p>Enter your Dynamsoft license key to get started with full features</p>
			</div>

			<div class="trial-info">
				<h3>üìù Need a License Key?</h3>
				<p>Get a free trial license key to unlock all features and start scanning documents right away.</p>
				<a href="https://www.dynamsoft.com/customer/license/trialLicense/?product=dcv&package=cross-platform"
					target="_blank" rel="noopener noreferrer" class="trial-link">Apply for Free Trial License ‚Üí</a>
			</div>

			<form class="license-form" id="licenseForm">
				<div class="form-group">
					<label for="licenseKey" class="form-label">License Key</label>
					<input type="text" id="licenseKey" class="form-input" placeholder="Enter your license key here..."
						spellcheck="false">
				</div>

				<div class="button-group">
					<button type="submit" class="btn btn-primary" id="activateBtn">
						<span id="activateText">Activate License</span>
						<span id="activateSpinner" class="loading-spinner ds-hidden"></span>
					</button>
					<button type="button" class="btn btn-secondary" id="useTrialBtn">
						Use Trial License
					</button>
				</div>
			</form>

			<div class="trial-info features">
				<h3>‚ú® What's Included:</h3>
				<p>
					‚Ä¢ Document scanning & image capture<br>
					‚Ä¢ Multi-page PDF creation<br>
					‚Ä¢ Drag & drop page reordering<br>
					‚Ä¢ Image enhancement tools
				</p>
			</div>
		</div>
	</div>

	<!-- Main Application -->
	<div id="appContainer" class="app-container">
		<div class="app-header">
			<h1 class="app-title">üìÑ Document Management</h1>
			<div class="license-status">
				<span class="status-indicator"></span>
				<span id="licenseStatusText">License Active</span>
			</div>
		</div>

		<div class="container">
			<div class="sidebar">
				<div class="sidebar-section">
					<h3 class="section-title">üéØ Actions</h3>
					<div class="action-buttons">
						<button class="action-btn" id="btnAcquireImage" onclick="DWTManager.acquireImage();">
							üì∑ Scan Document
						</button>
						<button class="action-btn" id="btnLoadImage" onclick="DWTManager.loadImage();">
							üìÅ Load Images
						</button>
					</div>
				</div>

				<div class="sidebar-section files">
					<h3 class="section-title">üìã Files</h3>
					<ul class="file-list">
						<li data-group="group-1" class="initial-hidden">
							<div class="file-info">
								<div class="title-name"></div>
								<em>
									<div class="page-number"></div>
								</em>
							</div>
							<label class="checkbox-label">
								<input type="checkbox" checked data-group="group-1">
								<span class="visually-hidden">Show/hide document group</span>
							</label>
						</li>
					</ul>
				</div>
			</div>

			<div class="main">
				<div class="ds-imagebox-wrapper">
					<div id="imagebox-1" docID="1" class="doc initial-hidden" data-group="group-1">
						<div class="doc-title">
							<span class="title-name"></span>
							<div class="doc-buttons">
								<button onclick="FileManager.save(this);">üíæ Save File</button>
								<button onclick="FileManager.delete(this);">üóëÔ∏è Delete</button>
							</div>
						</div>
						<div class="ds-imagebox mt10 thumbnails" ondrop="DragDrop.handleDrop.call(this, event)"
							ondragover="DragDrop.handleDragOver.call(this, event)"
							ondragenter="DragDrop.handleDragEnter.call(this, event)"
							ondragleave="DragDrop.handleDragLeave.call(this, event)"></div>
					</div>
				</div>

				<div class="dwt-container h600">
					<div id="dwtcontrolContainer" class="h600"></div>
				</div>
				<div class="ds-context-menu ds-hidden">
					<ul>
						<li id="liSplit">‚úÇÔ∏è Split</li>
						<li id="liDelete">üóëÔ∏è Delete</li>
						<li id="liMultiDelete">üóëÔ∏è Multi Delete</li>
					</ul>
				</div>
			</div>
		</div>
	</div>
	<script type="text/javascript">
		'use strict';

		// Constants
		const DEFAULT_LICENSE = "DLS2eyJoYW5kc2hha2VDb2RlIjoiMjAwMDAxLTE2NDk4Mjk3OTI2MzUiLCJvcmdhbml6YXRpb25JRCI6IjIwMDAwMSIsInNlc3Npb25QYXNzd29yZCI6IndTcGR6Vm05WDJrcEQ5YUoifQ==";
		const STORAGE_KEY = 'dynamsoft_license_key';
		const NOTIFICATION_DURATION = 3000;

		// Global state
		let currentLicenseKey = null;
		let isLicenseActivated = false;
		let DWTObject = null;
		let imageCount = 0;
		let pdfName = '';
		let draggedElement = null;
		let draggedImageBox = null;
		let currentImgEl = null;
		let rightClickImage = null;
		let lastSelectedImage = null;

		// Configuration
		Dynamsoft.DWT.ResourcesPath = 'https://unpkg.com/dwt/dist/';

		// Utility Functions
		const Utils = {
			generateScanFilename() {
				const now = new Date();
				const day = now.getDate().toString().padStart(2, '0');
				const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
					'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
				const month = monthNames[now.getMonth()];
				const year = now.getFullYear();
				let hour = now.getHours();
				const minute = now.getMinutes().toString().padStart(2, '0');
				const second = now.getSeconds().toString().padStart(2, '0');
				const isAM = hour < 12;
				const period = isAM ? 'AM' : 'PM';
				hour = hour % 12 || 12;
				hour = hour.toString().padStart(2, '0');
				return `Scan - ${day} ${month} ${year} ${hour}_${minute}_${second} ${period}.pdf`;
			},

			isNumber(value) {
				return Object.prototype.toString.call(value) === '[object Number]';
			},

			showNotification(message, type) {
				const notification = document.createElement('div');
				notification.className = `notification notification-${type}`;
				notification.style.cssText = `
					position: fixed;
					top: 20px;
					right: 20px;
					padding: 1rem 1.5rem;
					border-radius: 8px;
					color: white;
					font-weight: 600;
					z-index: 10000;
					animation: slideIn 0.3s ease;
					${type === 'success' ? 'background: #10b981;' : 'background: #ef4444;'}
				`;
				notification.textContent = message;

				// Add animation styles if not already present
				if (!document.getElementById('notification-styles')) {
					const style = document.createElement('style');
					style.id = 'notification-styles';
					style.textContent = `
						@keyframes slideIn {
							from { transform: translateX(100%); opacity: 0; }
							to { transform: translateX(0); opacity: 1; }
						}
					`;
					document.head.appendChild(style);
				}

				document.body.appendChild(notification);

				setTimeout(() => {
					notification.style.animation = 'slideIn 0.3s ease reverse';
					setTimeout(() => {
						if (notification.parentNode) {
							notification.parentNode.removeChild(notification);
						}
					}, 300);
				}, NOTIFICATION_DURATION);
			}
		};

		// License Management Module
		const LicenseManager = {
			init() {
				this.bindEvents();
				this.checkStoredLicense();
			},

			bindEvents() {
				const licenseForm = document.getElementById('licenseForm');
				const useTrialBtn = document.getElementById('useTrialBtn');

				licenseForm.addEventListener('submit', this.handleLicenseSubmit.bind(this));
				useTrialBtn.addEventListener('click', () => this.activateLicense(DEFAULT_LICENSE, true));
			},

			checkStoredLicense() {
				const storedLicense = localStorage.getItem(STORAGE_KEY);
				if (storedLicense && storedLicense !== DEFAULT_LICENSE) {
					document.getElementById('licenseKey').value = storedLicense;
				}
			},

			handleLicenseSubmit(event) {
				event.preventDefault();
				const licenseKey = document.getElementById('licenseKey').value.trim();

				if (!licenseKey) {
					Utils.showNotification('Please enter a license key', 'error');
					return;
				}

				this.activateLicense(licenseKey);
			},

			async activateLicense(licenseKey, isTrial = false) {
				this.setLoadingState(true);

				try {
					// Set the license key
					Dynamsoft.DWT.ProductKey = licenseKey;
					currentLicenseKey = licenseKey;

					// Store license key for future use (except for trial)
					if (!isTrial) {
						localStorage.setItem(STORAGE_KEY, licenseKey);
					}

					// Hide license overlay and show main app
					document.getElementById('licenseOverlay').style.display = 'none';
					document.getElementById('appContainer').classList.add('active');

					// Update license status
					this.updateLicenseStatus(isTrial);

					// Set license as activated before initializing DWT
					isLicenseActivated = true;

					// Initialize the DWT library
					DWTManager.initialize();

					const message = isTrial ? 'Trial license activated successfully!' : 'License activated successfully!';
					Utils.showNotification(message, 'success');

				} catch (error) {
					console.error('License activation failed:', error);
					Utils.showNotification('License activation failed. Please check your license key.', 'error');
				} finally {
					this.setLoadingState(false);
				}
			},

			setLoadingState(loading) {
				const activateBtn = document.getElementById('activateBtn');
				const useTrialBtn = document.getElementById('useTrialBtn');
				const activateText = document.getElementById('activateText');
				const activateSpinner = document.getElementById('activateSpinner');

				if (loading) {
					activateBtn.disabled = true;
					useTrialBtn.disabled = true;
					activateText.textContent = 'Activating...';
					activateSpinner.classList.remove('ds-hidden');
				} else {
					activateBtn.disabled = false;
					useTrialBtn.disabled = false;
					activateText.textContent = 'Activate License';
					activateSpinner.classList.add('ds-hidden');
				}
			},

			updateLicenseStatus(isTrial) {
				const statusText = document.getElementById('licenseStatusText');
				const statusIndicator = document.querySelector('.status-indicator');

				if (isTrial) {
					statusText.textContent = 'No Valid License';
					statusIndicator.style.backgroundColor = '#f59e0b';
				} else {
					statusText.textContent = 'License Valid';
					statusIndicator.style.backgroundColor = '#10b981';
				}
			}
		};

		// DWT Management Module
		const DWTManager = {
			initialize() {
				if (!isLicenseActivated) {
					console.warn('Cannot initialize DWT: License not activated');
					return;
				}

				pdfName = Utils.generateScanFilename();
				this.updateTitles();
				imageCount = 0;

				Dynamsoft.DWT.CreateDWTObjectEx({
					WebTwainId: 'mydwt-' + Date.now()
				}, (obj) => {
					DWTObject = obj;
					this.registerEvents();
					console.log('DWT Object initialized successfully');
				}, (err) => {
					console.error('DWT initialization failed:', err);
					Utils.showNotification('Failed to initialize scanner. Please check your license.', 'error');
				});
			},

			registerEvents() {
				DWTObject.RegisterEvent('OnPostTransferAsync', () => {
					// ImageManager.insert();
					// imageCount++;
				});

				DWTObject.RegisterEvent('OnPostLoad', () => {
					// ImageManager.insert();
					// imageCount++;
				});

				DWTObject.RegisterEvent('OnBufferChanged', (bufferChangeInfo) => {
					if (bufferChangeInfo['action'] === 'add') {
						ImageManager.insert();
						imageCount++;
					}
				});
			},

			updateTitles() {
				document.querySelectorAll('.title-name').forEach(el => {
					el.innerText = pdfName;
				});
			},

			acquireImage() {
				if (!DWTObject) {
					Utils.showNotification('Scanner not initialized. Please activate your license first.', 'error');
					return;
				}

				DWTObject.SelectSourceAsync()
					.then(() => {
						return DWTObject.AcquireImageAsync({
							IfCloseSourceAfterAcquire: true
						});
					})
					.then(() => {
						PageManager.showPages("group-1");
						Utils.showNotification('Document scanned successfully!', 'success');
					})
					.catch((exp) => {
						console.error(exp.message);
						Utils.showNotification('Scanning failed: ' + exp.message, 'error');
					});
			},

			loadImage() {
				if (!DWTObject) {
					Utils.showNotification('Scanner not initialized. Please activate your license first.', 'error');
					return;
				}

				DWTObject.LoadImageEx('', -1,
					() => {
						console.log('Images loaded successfully');
						PageManager.showPages("group-1");
						Utils.showNotification('Images loaded successfully!', 'success');
					},
					(a, b, c) => {
						console.error([a, b, c, DWTObject.ErrorCause]);
						Utils.showNotification('Failed to load images', 'error');
					}
				);
			}
		};

		// Page Management Module
		const PageManager = {
			updateAll() {
				document.querySelectorAll('.file-list input[type="checkbox"]').forEach(checkbox => {
					const group = checkbox.getAttribute('data-group');
					this.showPages(group);
				});
			},

			showPages(group) {
				const groupItem = document.querySelector(`li[data-group="${group}"]`);
				if (!groupItem) return;

				const pageNumberEl = groupItem.querySelector('.page-number');
				if (!pageNumberEl) return;

				const targetGroup = document.querySelector(`.doc[data-group="${group}"]`);
				if (targetGroup) {
					const images = targetGroup.querySelectorAll('.ds-dwt-image');
					pageNumberEl.textContent = `${images.length} pages`;
				}
			}
		};

		// Image Management Module
		const ImageManager = {
			insert() {
				if (!DWTObject) return;

				const currentImageIndex = imageCount;
				const currentImageUrl = DWTObject.GetImageURL(currentImageIndex);
				const currentImageID = DWTObject.IndexToImageID(currentImageIndex);

				const img = new Image();
				img.className = "ds-dwt-image";
				img.setAttribute("imageID", currentImageID);
				img.src = currentImageUrl;

				img.onload = () => {
					const wrapper = this.createImageWrapper(img);
					this.addToImageBox(wrapper);
				};
			},

			createImageWrapper(img) {
				const wrapper = document.createElement('div');
				wrapper.className = "ds-image-wrapper";
				wrapper.setAttribute("draggable", "true");
				wrapper.appendChild(img);

				// Add event listeners with proper binding
				wrapper.addEventListener('dragstart', DragDrop.handleDragStart);
				wrapper.addEventListener('dragend', DragDrop.handleDragEnd);
				wrapper.addEventListener('mousedown', (e) => ImageInteraction.handleMouseDown(e));

				return wrapper;
			},

			addToImageBox(wrapper) {
				const imageBox = document.getElementById('imagebox-1');

				// Show the imagebox when first image is added
				if (imageBox.classList.contains('initial-hidden')) {
					imageBox.classList.remove('initial-hidden');
					const fileListItem = document.querySelector('li[data-group="group-1"]');
					if (fileListItem) {
						fileListItem.classList.remove('initial-hidden');
						fileListItem.style.display = 'flex';
					}
				}

				imageBox.lastElementChild.appendChild(wrapper);
			}
		};

		// File Management Module
		const FileManager = {
			save(button) {
				const docDiv = button.closest('.doc');
				const imageTags = docDiv.querySelectorAll('img[imageid]');
				const imageIndexes = Array.from(imageTags).map(img => {
					const imageid = img.getAttribute('imageid');
					return DWTObject.ImageIDToIndex(imageid);
				});

				console.log('imageindex:', imageIndexes);

				DWTObject.SelectImages(imageIndexes);
				DWTObject.SaveSelectedImagesAsMultiPagePDF(
					pdfName,
					() => {
						console.log("PDF saved successfully");
						Utils.showNotification('PDF saved successfully!', 'success');
					},
					(errorCode, errorString) => {
						console.error('Save error:', errorString);
						Utils.showNotification('Failed to save PDF: ' + errorString, 'error');
					}
				);
			},

			delete(button) {
				const docDiv = button.closest('.doc');
				this.deleteDoc(docDiv);
			},

			deleteDoc(docDiv) {
				const imageTags = docDiv.querySelectorAll('img[imageid]');
				const imageIndexes = Array.from(imageTags).map(img => {
					const imageid = img.getAttribute('imageid');
					return DWTObject.ImageIDToIndex(imageid);
				});

				imageCount = imageCount - imageIndexes.length;
				DWTObject.SelectImages(imageIndexes);
				DWTObject.RemoveAllSelectedImages();

				if (docDiv) {
					const docId = docDiv.getAttribute('docid');

					if (docId === '1') {
						const wrappers = docDiv.querySelectorAll('.ds-image-wrapper');
						wrappers.forEach(wrapper => wrapper.remove());

						const remainingImages = docDiv.querySelectorAll('.ds-dwt-image');
						if (remainingImages.length === 0) {
							docDiv.classList.add('initial-hidden');
							const fileListItem = document.querySelector('li[data-group="group-1"]');
							if (fileListItem) {
								fileListItem.classList.add('initial-hidden');
							}
						}
					} else {
						docDiv.remove();
					}

					const group = docDiv.getAttribute('data-group');
					const groupItem = document.querySelector(`li[data-group="${group}"]`);
					if (groupItem && group !== 'group-1') {
						groupItem.remove();
					}
					PageManager.updateAll();
				}
				Utils.showNotification('Document deleted successfully!', 'success');
			},

			deleteOneImage(imageEl) {
				console.log('deleteOneImage');
				const imageID = imageEl.getAttribute("imageID");
				const imageIndex = DWTObject.ImageIDToIndex(imageID);

				DWTObject.RemoveImage(imageIndex);

				const imageWrapperDiv = imageEl.parentNode;
				const imageBoxDiv = imageWrapperDiv.parentNode;
				imageWrapperDiv.parentNode.removeChild(imageWrapperDiv);

				imageCount--;

				const docDiv = imageBoxDiv.closest('.doc');
				if (docDiv && docDiv.getAttribute('docid') === '1') {
					const remainingImages = docDiv.querySelectorAll('.ds-dwt-image');
					if (remainingImages.length === 0) {
						docDiv.classList.add('initial-hidden');
						const fileListItem = document.querySelector('li[data-group="group-1"]');
						if (fileListItem) {
							fileListItem.classList.add('initial-hidden');
						}
					}
				}
			},

			deleteEmptyDocs() {
				const imageWrappers = document.querySelectorAll('.ds-imagebox');
				imageWrappers.forEach(imageWrapper => {
					if (imageWrapper.childElementCount === 0) {
						const docDiv = imageWrapper.closest('.doc');
						this.deleteDoc(docDiv);
					}
				});
			}
		};

		// Document Splitting Module
		const DocumentSplitter = {
			splitImage(imageEl) {
				console.log('SplitImage');
				const imageWrapperDiv = imageEl.parentNode;
				const previousDivEl = imageWrapperDiv.previousSibling;
				if (previousDivEl) {
					this.createNextDocument(previousDivEl);
				}
			},

			createNextDocument(divImageWrapperEl) {
				const imageboxWrapper = document.querySelector('.ds-imagebox-wrapper');
				const currentDocumentEl = imageboxWrapper.lastElementChild;
				const documentID = 1 + parseInt(currentDocumentEl.getAttribute("docID"));

				const newDocGroup = this.createDocumentGroup(documentID);
				const newImageBox = this.createImageBox();

				newDocGroup.appendChild(this.createDocTitle());
				newDocGroup.appendChild(newImageBox);
				imageboxWrapper.appendChild(newDocGroup);

				// Move images to new document
				while (divImageWrapperEl.nextElementSibling) {
					const siblingWrapper = divImageWrapperEl.nextElementSibling;
					this.prepareImageWrapper(siblingWrapper);
					newImageBox.appendChild(siblingWrapper);
				}

				this.createFileListItem(documentID);
				Utils.showNotification('Document split successfully!', 'success');
			},

			createDocumentGroup(documentID) {
				const newDivGroup = document.createElement('div');
				newDivGroup.id = 'imagebox-' + documentID;
				newDivGroup.setAttribute('docID', documentID);
				newDivGroup.setAttribute('data-group', 'group-' + documentID);
				newDivGroup.className = "doc";
				return newDivGroup;
			},

			createDocTitle() {
				const docTitle = document.createElement('div');
				docTitle.className = "doc-title";

				const titleName = document.createElement('span');
				titleName.className = "title-name";
				titleName.innerText = pdfName;

				const buttons = document.createElement('div');
				buttons.className = "doc-buttons";

				const saveBtn = document.createElement('button');
				saveBtn.textContent = 'üíæ Save File';
				saveBtn.onclick = function () { FileManager.save(this); };

				const deleteBtn = document.createElement('button');
				deleteBtn.textContent = 'üóëÔ∏è Delete';
				deleteBtn.onclick = function () { FileManager.delete(this); };

				buttons.appendChild(saveBtn);
				buttons.appendChild(deleteBtn);
				docTitle.appendChild(titleName);
				docTitle.appendChild(buttons);

				return docTitle;
			},

			createImageBox() {
				const imageBox = document.createElement('div');
				imageBox.className = "ds-imagebox mt10 thumbnails";

				imageBox.addEventListener('drop', (e) => DragDrop.handleDrop.call(imageBox, e));
				imageBox.addEventListener('dragover', (e) => DragDrop.handleDragOver.call(imageBox, e));
				imageBox.addEventListener('dragenter', (e) => DragDrop.handleDragEnter.call(imageBox, e));
				imageBox.addEventListener('dragleave', (e) => DragDrop.handleDragLeave.call(imageBox, e));

				return imageBox;
			},

			prepareImageWrapper(wrapper) {
				if (!wrapper.hasAttribute('draggable')) {
					wrapper.setAttribute('draggable', 'true');
					wrapper.addEventListener('dragstart', DragDrop.handleDragStart);
					wrapper.addEventListener('dragend', DragDrop.handleDragEnd);
					wrapper.addEventListener('mousedown', (e) => ImageInteraction.handleMouseDown(e));
				}
			},

			createFileListItem(documentID) {
				const ul = document.querySelector('ul.file-list');
				const newLiGroup = document.createElement('li');
				newLiGroup.setAttribute('data-group', 'group-' + documentID);

				const fileInfo = document.createElement('div');
				fileInfo.className = 'file-info';

				const titleName = document.createElement('div');
				titleName.className = 'title-name';
				titleName.innerText = pdfName;

				const em = document.createElement('em');
				const pageNumber = document.createElement('div');
				pageNumber.className = "page-number";
				pageNumber.innerText = "0 pages";

				const checkboxLabel = document.createElement('label');
				checkboxLabel.className = 'checkbox-label';

				const checkbox = document.createElement('input');
				checkbox.type = 'checkbox';
				checkbox.checked = true;
				checkbox.setAttribute('data-group', 'group-' + documentID);
				checkbox.addEventListener('change', EventHandlers.changeCheckboxValue);

				const hiddenText = document.createElement('span');
				hiddenText.className = 'visually-hidden';
				hiddenText.textContent = 'Show/hide document group';

				em.appendChild(pageNumber);
				fileInfo.appendChild(titleName);
				fileInfo.appendChild(em);
				checkboxLabel.appendChild(checkbox);
				checkboxLabel.appendChild(hiddenText);
				newLiGroup.appendChild(fileInfo);
				newLiGroup.appendChild(checkboxLabel);
				ul.appendChild(newLiGroup);

				// Update page count
				const newDocGroup = document.querySelector(`[data-group="group-${documentID}"].doc`);
				if (newDocGroup) {
					const images = newDocGroup.querySelectorAll('.ds-dwt-image');
					pageNumber.textContent = `${images.length} pages`;
				}
			}
		};

		// Context Menu and Interaction Handlers
		const ContextMenu = {
			init() {
				this.bindEvents();
			},

			bindEvents() {
				document.addEventListener('contextmenu', this.handleContextMenu.bind(this));
				document.addEventListener('click', this.handleClick.bind(this));

				document.getElementById('liSplit').addEventListener('click', this.handleSplit.bind(this));
				document.getElementById('liDelete').addEventListener('click', this.handleDelete.bind(this));
				document.getElementById('liMultiDelete').addEventListener('click', this.handleMultiDelete.bind(this));
			},

			handleContextMenu(e) {
				e.preventDefault();
				currentImgEl = null;

				const menu = document.querySelector('.ds-context-menu');
				if (!menu) return;

				let targetElement = e.target;
				if (targetElement.classList.contains('ds-image-wrapper')) {
					targetElement = targetElement.querySelector('img');
				}

				currentImgEl = targetElement;
				if (currentImgEl && currentImgEl.tagName === 'IMG') {
					menu.style.left = e.pageX + 'px';
					menu.style.top = e.pageY + 'px';
					menu.className = "ds-context-menu";
				} else {
					menu.className = "ds-context-menu ds-hidden";
				}
				ImageInteraction.clearRightClickHighlight();
			},

			handleClick() {
				ImageInteraction.clearRightClickHighlight();
				const menu = document.querySelector('.ds-context-menu');
				if (menu) {
					menu.className = "ds-context-menu ds-hidden";
				}
			},

			handleSplit() {
				ImageInteraction.clearRightClickHighlight();
				if (currentImgEl) {
					DocumentSplitter.splitImage(currentImgEl);
				}
				PageManager.updateAll();
			},

			handleDelete() {
				ImageInteraction.clearRightClickHighlight();
				if (currentImgEl) {
					FileManager.deleteOneImage(currentImgEl);
					currentImgEl = null;
				}
				PageManager.updateAll();
			},

			handleMultiDelete() {
				ImageInteraction.clearRightClickHighlight();
				const images = document.querySelectorAll("IMG.selectedImage");
				images.forEach(imgEl => {
					FileManager.deleteOneImage(imgEl);
				});
				FileManager.deleteEmptyDocs();
			}
		};

		// Image Interaction Module
		const ImageInteraction = {
			handleMouseDown(e) {
				if (e.button === 2) {
					// Right click - handle context menu
					e.preventDefault();
					this.clearRightClickHighlight();

					let imgElement = e.target;
					if (imgElement.classList.contains('ds-image-wrapper')) {
						imgElement = imgElement.querySelector('img');
					}

					rightClickImage = imgElement;
					if (rightClickImage && rightClickImage.tagName === 'IMG') {
						rightClickImage.style.opacity = '0.4';
						rightClickImage.parentNode.style.backgroundColor = '#F1F1F1';
					} else {
						rightClickImage = null;
					}
					return;
				} else {
					// Left click - handle selection
					this.clearRightClickHighlight();

					let imgElement = e.target;
					if (imgElement.classList.contains('ds-image-wrapper')) {
						imgElement = imgElement.querySelector('img');
					}

					if (imgElement && imgElement.tagName === 'IMG') {
						const fakeEvent = {
							target: imgElement,
							ctrlKey: e.ctrlKey,
							shiftKey: e.shiftKey
						};
						ImageSelection.select(fakeEvent);
					}
				}
			},

			clearRightClickHighlight() {
				if (rightClickImage) {
					rightClickImage.style.opacity = '';
					rightClickImage.parentNode.style.backgroundColor = '';
					rightClickImage = null;
				}
			}
		};

		// Image Selection Module
		const ImageSelection = {
			select(e) {
				const bCtrlKeyPressed = e.ctrlKey;
				const bShiftKeyPressed = e.shiftKey;

				if (!bCtrlKeyPressed && !bShiftKeyPressed) {
					this.unselectAll();
				}

				const previousLastSelected = lastSelectedImage;
				lastSelectedImage = e.target;

				if (bShiftKeyPressed && previousLastSelected) {
					this.selectRange(previousLastSelected, lastSelectedImage);
				} else {
					lastSelectedImage.classList.add('selectedImage');
				}
			},

			selectRange(startImage, endImage) {
				const startImageID = startImage.getAttribute('imageid');
				const endImageID = endImage.getAttribute('imageid');

				if (!startImageID || !endImageID) return;

				let imageIndex1 = DWTObject.ImageIDToIndex(startImageID);
				let imageIndex2 = DWTObject.ImageIDToIndex(endImageID);

				if (!Utils.isNumber(imageIndex1) || !Utils.isNumber(imageIndex2)) return;

				if (imageIndex1 > imageIndex2) {
					[imageIndex1, imageIndex2] = [imageIndex2, imageIndex1];
				}

				for (let i = imageIndex1 + 1; i < imageIndex2; i++) {
					const tmpImageID = DWTObject.IndexToImageID(i);
					if (tmpImageID) {
						const tmpImageEl = document.querySelector(`IMG[imageid="${tmpImageID}"]`);
						if (tmpImageEl) {
							tmpImageEl.classList.add('selectedImage');
						}
					}
				}
				endImage.classList.add('selectedImage');
			},

			unselectAll() {
				document.querySelectorAll('IMG.selectedImage').forEach(img => {
					img.classList.remove('selectedImage');
				});
			}
		};

		// Drag and Drop Module
		const DragDrop = {
			handleDragStart(e) {
				draggedElement = this;
				draggedImageBox = this.closest('.ds-imagebox');
				e.dataTransfer.effectAllowed = 'move';
				e.dataTransfer.setData('text/html', this.outerHTML);
				this.style.opacity = '0.5';
			},

			handleDragEnd() {
				this.style.opacity = '';
				draggedElement = null;
				draggedImageBox = null;

				document.querySelectorAll('.ds-imagebox').forEach(box => {
					box.classList.remove('drag-over');
				});
			},

			handleDragOver(e) {
				if (e.preventDefault) {
					e.preventDefault();
				}
				e.dataTransfer.dropEffect = 'move';
				return false;
			},

			handleDragEnter() {
				if (draggedElement && this && typeof this.classList !== 'undefined') {
					this.classList.add('drag-over');
				}
			},

			handleDragLeave(e) {
				if (e.relatedTarget && this && typeof this.contains === 'function' && !this.contains(e.relatedTarget)) {
					this.classList.remove('drag-over');
				} else if (!e.relatedTarget) {
					this.classList.remove('drag-over');
				}
			},

			handleDrop(e) {
				if (e.stopPropagation) {
					e.stopPropagation();
				}

				const targetImageBox = e.currentTarget;
				targetImageBox.classList.remove('drag-over');

				if (!draggedElement) return false;

				if (targetImageBox !== draggedImageBox) {
					// Moving between different imageboxes
					DragDrop.insertAtPosition(targetImageBox, e.clientX);
				} else {
					// Reordering within the same imagebox
					DragDrop.reorderInSameBox(targetImageBox, e.clientX);
				}

				PageManager.updateAll();
				return false;
			},

			insertAtPosition(targetImageBox, clientX) {
				const rect = targetImageBox.getBoundingClientRect();
				const x = clientX - rect.left;
				const children = Array.from(targetImageBox.children);
				let insertIndex = children.length;

				for (let i = 0; i < children.length; i++) {
					const child = children[i];
					const childRect = child.getBoundingClientRect();
					const childX = childRect.left - rect.left + childRect.width / 2;

					if (x < childX) {
						insertIndex = i;
						break;
					}
				}

				if (insertIndex >= children.length) {
					targetImageBox.appendChild(draggedElement);
				} else {
					targetImageBox.insertBefore(draggedElement, children[insertIndex]);
				}
			},

			reorderInSameBox(targetImageBox, clientX) {
				const rect = targetImageBox.getBoundingClientRect();
				const x = clientX - rect.left;
				const children = Array.from(targetImageBox.children).filter(child => child !== draggedElement);
				let insertIndex = children.length;

				for (let i = 0; i < children.length; i++) {
					const child = children[i];
					const childRect = child.getBoundingClientRect();
					const childX = childRect.left - rect.left + childRect.width / 2;

					if (x < childX) {
						insertIndex = i;
						break;
					}
				}

				if (insertIndex >= children.length) {
					targetImageBox.appendChild(draggedElement);
				} else {
					targetImageBox.insertBefore(draggedElement, children[insertIndex]);
				}
			}
		};

		// Event Handlers Module
		const EventHandlers = {
			changeCheckboxValue() {
				const group = this.getAttribute('data-group');
				const targetGroup = document.querySelector(`.doc[data-group="${group}"]`);
				if (this.checked) {
					targetGroup.style.display = "";
				} else {
					targetGroup.style.display = "none";
				}
			},

			initializeCheckboxes() {
				document.querySelectorAll('.file-list input[type="checkbox"]').forEach(checkbox => {
					checkbox.addEventListener('change', this.changeCheckboxValue);
				});

				document.querySelectorAll('.file-list input[type="checkbox"]:checked').forEach(checkbox => {
					const group = checkbox.getAttribute('data-group');
					const targetGroup = document.querySelector(`.doc[data-group="${group}"]`);
					if (targetGroup) {
						targetGroup.classList.add('active');
					}
				});
			}
		};

		// Application Initialization
		const App = {
			init() {
				LicenseManager.init();
				ContextMenu.init();
				EventHandlers.initializeCheckboxes();
			}
		};

		// Initialize the application when DOM is loaded
		document.addEventListener('DOMContentLoaded', App.init);

	</script>

</body>

</html>